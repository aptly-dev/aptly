#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk

export GOPATH=$(shell pwd)/.go
export DEB_BUILD_OPTIONS=crossbuildcanrunhostbinaries

export GOARCH := $(shell if [ $(DEB_TARGET_ARCH) = "i386" ]; then echo "386"; elif [ $(DEB_TARGET_ARCH) = "armhf" ]; then echo "arm"; else echo  $(DEB_TARGET_ARCH); fi)
export DEBIAN_DEPS := $(shell . /etc/os-release; if [ "$$ID" = "debian" ]; then if [ -n "$$VERSION_ID" ] && [ "$$VERSION_ID" -ge 13 ] || [ "$$VERSION_CODENAME" = "trixie" ]; then echo 1; fi; fi)

%:
	dh $@ --buildsystem=golang --with=golang

override_dh_auto_clean:
	rm -rf build/
	rm -rf obj-$(DEB_TARGET_GNU_TYPE)/
	dh_auto_clean

override_dh_auto_build:
	if [ $$DEBIAN_DEPS -eq 1 ]; then \
		echo "Running debian build ..." ; \
		echo $(DEB_VERSION) > obj-$(DEB_TARGET_GNU_TYPE)/src/github.com/aptly-dev/aptly/VERSION ; \
		dh_auto_build ; \
	else \
		echo "Running go build ..." ; \
		echo $(DEB_VERSION) > VERSION ; \
		go build -o build/aptly ; \
	fi

override_dh_auto_test:

override_dh_auto_install:
	dh_auto_install -- --no-source
	mkdir -p build
	test -f debian/tmp/usr/bin/aptly && mv debian/tmp/usr/bin/aptly build/ || true
	mkdir -p debian/aptly/usr/share/man/man1/ debian/aptly/usr/share/bash-completion/completions/
	cp man/aptly.1 debian/aptly/usr/share/man/man1
	cp completion.d/aptly debian/aptly/usr/share/bash-completion/completions/
	gzip debian/aptly/usr/share/man/man1/aptly.1

override_dh_strip:
	dh_strip --dbg-package=aptly-dbg

override_dh_golang:
	if [ $$DEBIAN_DEPS -eq 1 ]; then \
		echo "Running dh_golang ..." ; \
		dh_golang ; \
	fi

override_dh_makeshlibs: # fails when cross compiling
	if [ "$(DEB_BUILD_ARCH_CPU)" = "$(DEB_HOST_ARCH_CPU)" ]; then \
		echo "Running dh_makeshlibs ..." ; \
		dh_makeshlibs ; \
	fi

override_dh_shlibdeps: # fails when cross compiling
	if [ "$(DEB_BUILD_ARCH_CPU)" = "$(DEB_HOST_ARCH_CPU)" ]; then \
		echo "Running dh_shlibdeps ..." ; \
		dh_shlibdeps ; \
	fi
